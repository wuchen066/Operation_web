'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

const Path = require('path');
const shared = require('@vuedx/shared');
const JSON5 = require('json5');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

function _interopNamespace(e) {
    if (e && e.__esModule) return e;
    const n = Object.create(null);
    if (e) {
        for (const k in e) {
            if (k !== 'default') {
                const d = Object.getOwnPropertyDescriptor(e, k);
                Object.defineProperty(n, k, d.get ? d : {
                    enumerable: true,
                    get: function () { return e[k]; }
                });
            }
        }
    }
    n["default"] = e;
    return Object.freeze(n);
}

const Path__namespace = /*#__PURE__*/_interopNamespace(Path);
const Path__default = /*#__PURE__*/_interopDefaultLegacy(Path);
const JSON5__default = /*#__PURE__*/_interopDefaultLegacy(JSON5);

const DEFAULT_PROJECT_CONFIG = {
    globalComponents: {},
    globalDirectives: {},
    preferences: {
        componentsDirectories: ['src/components'],
        script: { mode: 'setup', language: 'js' },
        style: { language: 'css' },
        template: {
            directiveSyntax: 'shorthand',
            propCase: 'camel',
            tagCase: 'auto',
        },
    },
};

function deepDefaults(a, b) {
    if (b == null)
        return a;
    Object.keys(b).forEach((key) => {
        const valueA = a[key];
        const valueB = b[key];
        if (valueB === undefined)
            return;
        if (valueA == null || Array.isArray(valueB)) {
            a[key] = valueB;
        }
        else if (typeof valueA === 'object' && typeof valueB === 'object') {
            a[key] = deepDefaults(valueA, valueB);
        }
        else {
            a[key] = valueB;
        }
    });
    return a;
}

var FileWatcherEventKind;
(function (FileWatcherEventKind) {
    FileWatcherEventKind[FileWatcherEventKind["Created"] = 0] = "Created";
    FileWatcherEventKind[FileWatcherEventKind["Changed"] = 1] = "Changed";
    FileWatcherEventKind[FileWatcherEventKind["Deleted"] = 2] = "Deleted";
})(FileWatcherEventKind || (FileWatcherEventKind = {}));
function findNearestFile(fs, dir, name) {
    let cur = shared.toPosixPath(dir);
    while (cur.length > 1) {
        const fileName = Path__namespace.posix.resolve(cur, name);
        if (fs.fileExists(fileName))
            return fileName;
        cur = Path__namespace.posix.dirname(cur);
    }
    return null;
}

function resolveComponents(rootDir, resources) {
    const components = {};
    const add = (name, source) => {
        const sources = components[name] ?? (components[name] = []);
        if (sources.some((item) => item.moduleName === source.moduleName &&
            item.exportName === source.exportName)) {
            return; // duplicate
        }
        sources.push(source);
    };
    for (const resource of resources) {
        if (shared.isString(resource)) {
            add(shared.getComponentName(resource), {
                moduleName: resolve(resource),
            });
        }
        else {
            Object.entries(resource).forEach(([key, value]) => {
                add(key, shared.isString(value) ? { moduleName: resolve(value) } : value);
            });
        }
    }
    return components;
    function resolve(resource) {
        if (resource.startsWith('.'))
            return Path__default["default"].posix.resolve(rootDir, resource);
        else
            return resource;
    }
}

function resolveDirectives(rootDir, resources) {
    const directives = {};
    const add = (name, source) => {
        const sources = directives[name] ?? (directives[name] = []);
        if (sources.some((item) => item.moduleName === source.moduleName &&
            item.exportName === source.exportName)) {
            return; // duplicate
        }
        sources.push(source);
    };
    for (const resource of resources) {
        if (shared.isString(resource)) ;
        else
            Object.entries(resource).forEach(([key, value]) => {
                add(key, shared.isString(value) ? { moduleName: resolve(value) } : value);
            });
    }
    return directives;
    function resolve(resource) {
        if (resource.startsWith('.'))
            return Path__default["default"].posix.resolve(rootDir, resource);
        else
            return resource;
    }
}

class VueProject {
    constructor(fs, rootDir, packageFile = null, projectFile = null) {
        this.fs = fs;
        this.rootDir = rootDir;
        this.packageFile = packageFile;
        this.projectFile = projectFile;
        this.watchers = [];
        this._projectVersion = 1;
        this._dependencies = {};
        this._config = DEFAULT_PROJECT_CONFIG;
        this._vueVersion = '3.2.0';
        this.runtimeFile = Path__namespace.resolve(rootDir, 'project.vuedx_project_runtime.d.ts');
        this.onPackageFileChange();
        this.onProjectFileChange();
        if (packageFile != null) {
            this.watchers.push(fs.watchFile(packageFile, (_fileName, event) => {
                if (event === FileWatcherEventKind.Changed) {
                    this.onPackageFileChange();
                }
            }));
        }
        if (projectFile != null) {
            this.watchers.push(fs.watchFile(projectFile, (_fileName, event) => {
                if (event === FileWatcherEventKind.Changed) {
                    this.onProjectFileChange();
                }
                else if (event === FileWatcherEventKind.Deleted) {
                    this._config = DEFAULT_PROJECT_CONFIG;
                }
            }));
        }
    }
    static create(fs, rootDir) {
        const projectFile = Path__namespace.posix.resolve(rootDir, 'vueconfig.json');
        const packageFile = findNearestFile(fs, rootDir, 'package.json');
        return new VueProject(fs, rootDir, packageFile, fs.fileExists(projectFile) ? projectFile : null);
    }
    get vueVersion() {
        return this._vueVersion;
    }
    get projectVersion() {
        return this._projectVersion;
    }
    onProjectFileChange() {
        if (this.projectFile == null)
            return;
        const content = this.fs.readFile(this.projectFile);
        if (content != null) {
            try {
                this.setConfig(JSON5__default["default"].parse(content));
            }
            catch (e) {
                const error = e;
                console.error(`[VueDX] (ProjectConfig) ${error.message} ${error.stack ?? ''}`);
            }
        }
    }
    onPackageFileChange() {
        if (this.packageFile == null)
            return;
        const content = this.fs.readFile(this.packageFile);
        if (content != null) {
            try {
                const pkg = JSON.parse(content);
                this.loadDependencies({
                    ...pkg.devDependencies,
                    ...pkg.dependencies,
                });
            }
            catch (e) {
                const error = e;
                console.error(`[VueDX] (ProjectConfig) ${error.message} ${error.stack ?? ''}`);
            }
            const vueVersion = this._dependencies['vue'];
            if (vueVersion != null) {
                this._vueVersion = vueVersion;
            }
        }
    }
    loadDependencies(dependencies) {
        if (this.packageFile == null)
            return;
        const modulesDir = Path__namespace.posix.resolve(Path__namespace.posix.dirname(this.packageFile), 'node_modules');
        Object.keys(dependencies).forEach((packageName) => {
            const fileName = Path__namespace.posix.resolve(modulesDir, packageName, 'package.json');
            if (this.fs.fileExists(fileName)) {
                try {
                    this._dependencies[packageName] = JSON.parse(this.fs.readFile(fileName) ?? '{}').version;
                }
                catch (e) {
                    const error = e;
                    console.error(`[VueDX] (ProjectConfig) ${error.message} in ${fileName} ${error.stack ?? ''}`);
                    this._dependencies[packageName] = '0.0.0';
                }
            }
        });
    }
    dispose() {
        this.watchers.forEach((watcher) => watcher.close());
        this.watchers.length = 0;
    }
    get dependencies() {
        return this._dependencies;
    }
    get config() {
        return this._config;
    }
    setConfig(config) {
        this._config = {
            globalComponents: this._config.globalComponents,
            globalDirectives: this._config.globalDirectives,
            preferences: deepDefaults(this._config.preferences, config.preferences),
        };
        if (config.globalComponents != null) {
            this._config.globalComponents = resolveComponents(this.rootDir, config.globalComponents);
        }
        if (config.globalDirectives != null) {
            this._config.globalDirectives = resolveDirectives(this.rootDir, config.globalDirectives);
        }
        this._projectVersion += 1;
    }
    get kind() {
        return this.projectFile == null ? 'inferred' : 'configured';
    }
}

const version = "0.7.3";

exports.VueProject = VueProject;
exports.version = version;
//# sourceMappingURL=index.cjs.map
